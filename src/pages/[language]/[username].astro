---
import { db } from "astro:db";
import { languages } from "../../lib/supportedLanguages";
import { RoastCollection } from "astro:db";
import { eq } from "astro:db";
import Layout from "../../layouts/Layout.astro";
import { and } from "astro:db";
import { Card, Divider } from "astrolace:components";


const { language, username } = Astro.params;

if (!language || !username) {
    throw new Error("Language and username are required.");
}

if ( languages[language] === undefined || languages[language] === null ) {
    throw new Error(`Language "${language}" is not yet supported.`);
}

const roastData = await db
    .select()
    .from(RoastCollection)
    .where(and(
        eq(RoastCollection.username, username), 
        eq(RoastCollection.language, language)
    ))
    .get();

---

<Layout title={`Roast for ${username}`}>

    <div class="w-[100vw] flex align-center justify-center p-4">
        <Card class="px-8 sm:w-full md:w-[50vw]">
            <h1 class="text-2xl font-bold">Roast for <a class="text-blue" href={`https://github.com/${username}`}>{username}</a></h1>

            <Divider />

            {roastData ? (
                <p>{roastData.response}</p>
            ) : (
                <p>No roast found for {username} in {language}.</p>
            )}
        </Card>
    </div>
</Layout>