---
import Layout from "../layouts/Layout.astro";
import { Card, Input, Select, Option, Button } from "astrolace:components";
import { languages } from "../lib/supportedLanguages";
import PreviousRoasts from "../components/PreviousRoasts.astro";
import { getRoasts, makeDescription, getOgImagePath } from "../lib/roastCollection";

const roast = (await getRoasts()).lastRoast;

const description = makeDescription(roast);
const ogImage = getOgImagePath(roast);
---
<Layout 
	title="Get Roasted" 
	description={description} 
	ogImage={ogImage}
	>
	
	<Card class="sm:w-full sm:px-8 md:px-32 lg:px-64">

		<h2 class="text-3xl font-bold pb-2">Get Roasted</h2>

		<div class="divider"></div>

		<form id="roast" method="POST" action="/api/openai">
			<Input 
				form="roast" 
				name="username" 
				placeholder="Enter your friend's Username" 
				label="Github Username or Organization" 
				helpText="Username or Organization" 
				/>

			<div class="py-2"></div>

			<Select form="roast" name="language" value="english" label="Language">
				{
					Object.entries(languages).map(([key, value]) => (
						<Option value={key}>{value.name}</Option>
					))
				}
			</Select>

			<div class="py-2"></div>

			<Button 
				form="roast" 
				id="roastbutton" 
				variant="primary" 
				size="medium" 
				type="submit"
				class="font-bold"
				>Roast 'em!
			</Button>
		</form>
	</Card>

	<div class="py-2"></div>

	<Card id="roast-result" style="display: none;" class="sm:w-full sm:px-8 md:px-32 lg:px-64">
		
		<h2 class="text-2xl font-bold">Roast Result</h2>

        <div class="py-2 divider"></div>
		
		<p style="white-space: pre-line;">Your roast will appear here!</p>
		
		<div class="pt-4 text-blue font-bold text-align-right">
			<a id="roastedurlpath" href="#">Shareable link</a>
		</div>

	</Card>

	<div class="py-2"></div>

	<PreviousRoasts />
	
	<script>
	import type { SlButton } from "astrolace:types";
	import JSConfetti from 'js-confetti'
	
		const form = document.getElementById('roast') as HTMLFormElement;
		const roastButton = document.getElementById('roastbutton') as SlButton;

		form?.addEventListener('submit', async (event) => {
			event.preventDefault();

			const jsConfetti = new JSConfetti()
			roastButton.loading = true;
			roastButton.disabled = true;

			const formData = new FormData(form);
			const username = formData.get('username');
			const language = formData.get('language');

			// Perform the fetch request to the OpenAI API
			fetch(form.action, {
				method: form.method,
				body: new FormData(form),
			})
			.then(response => response.json())
			.then(data => {
				// Update the roast result card with the response

				const roastResultCard = document.querySelector('#roast-result') as HTMLDivElement;
				roastResultCard.style.display = 'block';
				const roastResultText = roastResultCard.querySelector('p') as HTMLParagraphElement;
				roastResultText.textContent = data.roast;

				// Update the shareable link
				const roastedUrlPath = document.querySelector('#roastedurlpath') as HTMLAnchorElement;
				roastedUrlPath.href = `/${language}/${username}`;
				roastButton.loading = false;
				roastButton.disabled = false;

				// Trigger confetti animation
				jsConfetti.addConfetti()
			})
			.catch(error => {
				console.error('Error:', error);
				roastButton.loading = false;
				roastButton.disabled = false;
			});
		});
	</script>
</Layout>